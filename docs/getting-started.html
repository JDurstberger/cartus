<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Getting Started</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Cartus</span> <span class="project-version">0.1.3</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="getting-started.html"><div class="inner"><span>Getting Started</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cartus</span></div></div></li><li class="depth-2 branch"><a href="cartus.cambium.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cambium</span></div></a></li><li class="depth-2 branch"><a href="cartus.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><a href="cartus.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#getting-started" name="getting-started"></a>Getting Started</h1>
<p><code>cartus</code> is a structured logging abstraction for logging data rich events with support for multiple logging backends, currently including:</p>
<ul>
  <li>a test logger for collecting logs in memory and asserting against  them; and</li>
  <li>a <a href="https://cambium-clojure.github.io/"><code>cambium</code></a> logger for logging  out via <a href="http://www.slf4j.org/"><code>SLF4J</code></a> and  <a href="http://logback.qos.ch/"><code>logback</code></a>.</li>
</ul>
<p><code>cartus</code> is heavily inspired by <a href="https://juxt.pro/blog/logging">JUXT’s blog post on logging</a> which recommends treating the logger as an injectable dependency like any other. Among other things, this makes testing easier and allows the logging backend to be switched out for different contexts.</p>
<h2><a href="#installation" name="installation"></a>Installation</h2>
<p>Add the following to your <code>project.clj</code> file:</p>
<pre><code class="clojure">[io.logicblocks/cartus "0.1.3"]
</code></pre>
<h2><a href="#configuring-a-backend" name="configuring-a-backend"></a>Configuring a backend</h2>
<h3><a href="#the-backend" name="the-backend"></a>The <code>cartus.test/logger</code> backend</h3>
<p>The <a href="cartus.test.html#var-logger">cartus.test/logger</a> backend captures all logged events in memory in an atom, allowing tests to assert that log events took place.</p>
<p>To create a <code>cartus.test/logger</code>:</p>
<pre><code class="clojure">(require '[cartus.test])

(def logger (cartus.test/logger))
</code></pre>
<h3><a href="#the-backend" name="the-backend"></a>The <code>cartus.cambium/logger</code> backend</h3>
<p>The <a href="cartus.cambium.html#var-logger">cartus.cambium/logger</a> backend passes all logged events to <code>cambium</code> which in turn uses <a href="http://www.slf4j.org/"><code>SLF4J</code></a> and <a href="http://logback.qos.ch/"><code>logback</code></a> to log out the log event either in a plain text format or as JSON.</p>
<p>To use the <code>cambium</code> logger, you must first choose a codec and backend for <code>cambium</code>. </p>
<p>To use plain text logs, add the following to your <code>project.clj</code> file:</p>
<pre><code class="clojure">[cambium/cambium.codec-simple "0.9.3"]
</code></pre>
<p>and add logback configuration (typically at <code>resources/logback.xml</code>) containing something like the following:</p>
<pre><code class="xml">&lt;configuration&gt;
  &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
    &lt;encoder&gt;
      &lt;pattern&gt;
        %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg { %mdc }%n
      &lt;/pattern&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;
  &lt;root level="debug"&gt;
    &lt;appender-ref ref="STDOUT" /&gt;
  &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<p>To use JSON logs, add the following to your <code>project.clj</code> file:</p>
<pre><code class="clojure">[cambium/cambium.codec-cheshire "0.9.3"]
[cambium/cambium.logback.json   "0.4.3"]
</code></pre>
<p>and add logback configuration (again, typically at <code>resources/logback.xml</code>) containing something like the following:</p>
<pre><code class="xml">&lt;configuration&gt;
  &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
    &lt;encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder"&gt;
      &lt;layout class="cambium.logback.json.FlatJsonLayout"&gt;
        &lt;jsonFormatter class="ch.qos.logback.contrib.jackson.JacksonJsonFormatter"&gt;
          &lt;prettyPrint&gt;true&lt;/prettyPrint&gt;
        &lt;/jsonFormatter&gt;
        &lt;timestampFormat&gt;yyyy-MM-dd'T'HH:mm:ss.SSS'Z'&lt;/timestampFormat&gt;
        &lt;timestampFormatTimezoneId&gt;UTC&lt;/timestampFormatTimezoneId&gt;
        &lt;appendLineSeparator&gt;true&lt;/appendLineSeparator&gt;
      &lt;/layout&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;
  &lt;root level="debug"&gt;
    &lt;appender-ref ref="STDOUT" /&gt;
  &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<p>For more details of configuring <code>cambium</code> backends, see the <a href="https://cambium-clojure.github.io/"><code>cambium</code> documentation</a>.</p>
<p>Once a <code>cambium</code> codec and backend has been configured, <code>cambium</code> must be initialised as the system starts up. This can be achieved with the following:</p>
<pre><code class="clojure">(require '[cartus.cambium])

(cartus.cambium/initialise)
</code></pre>
<p>See <a href="cartus.cambium.html#var-initialise">cartus.cambium/initialise</a> for more details on initialisation options.</p>
<p>Once <code>cambium</code> is initialised, to create a <code>cartus.cambium/logger</code>:</p>
<pre><code class="clojure">(def logger (cartus.cambium/logger))
</code></pre>
<h3><a href="#custom-backends" name="custom-backends"></a>Custom backends</h3>
<p>All <code>cartus.core</code> functions expect an implementation of the <a href="cartus.core.html#var-Logger">cartus.core/Logger</a> protocol. To create a custom backend, simply implement this protocol - the protocol’s documentation gives full details of expectations on implementors.</p>
<h2><a href="#logging-events" name="logging-events"></a>Logging events</h2>
<p>Log events:</p>
<ul>
  <li>are logged at a specific <code>level</code>, typically one of <code>:trace</code>, <code>:debug</code>,  <code>:info</code>, <code>:warn</code>, <code>:error</code> or <code>:fatal</code>;</li>
  <li>have a <code>type</code>, expressed as a keyword, such as  <code>:some.namespace/some.event.type</code>;</li>
  <li>include a map of additional <code>context</code>, which can be deeply nested;</li>
  <li>optionally include a <code>message</code> giving a textual description of the event;</li>
  <li>optionally include an <code>exception</code> including more details of an error;</li>
  <li>optionally include a <code>meta</code> map, including any metadata at the point of  the call to the logger such as the line, column and  namespace of the call.</li>
</ul>
<p>The convenience macros <a href="cartus.core.html#var-trace">cartus.core/trace</a>, <a href="cartus.core.html#var-debug">cartus.core/debug</a>, <a href="cartus.core.html#var-info">cartus.core/info</a>, <a href="cartus.core.html#var-warn">cartus.core/warn</a>, <a href="cartus.core.html#var-error">cartus.core/error</a> and <a href="cartus.core.html#var-fatal">cartus.core/fatal</a> are used to log events at each respective level, capturing metadata for the call site automatically: </p>
<pre><code class="clojure">(ns example.logging
  (:require
   [cartus.core :as log]
   [cartus.cambium]))

(cartus.cambium/initialise)

(def logger (cartus.cambium/logger))

(log/trace logger ::system.started 
  {:flags {:in-memory-database false
           :live-services false}})
; =&gt; 
; "{
;   \"timestamp\" : \"2020-07-18T16:59:36.625Z\",
;   \"level\" : \"TRACE\",
;   \"thread\" : \"nREPL-session-ea7676d2-b76c-44c4-bc2b-d1c2f8515c0b\",
;   \"ns\" : \"example.logging\",
;   \"line\" : 10,
;   \"column\" : 1,
;   \"flags\" : {
;     \"in-memory-database\" : false,
;     \"live-services\" : false
;   },
;   \"type\" : \"example.logging/system.started\",
;   \"logger\" : \"example.logging\",
;   \"message\" : \"example.logging/system.started\",
;   \"context\" : \"default\"
; }
; "

(log/info logger ::database.migrating
  {:target-schema-version 10})
; =&gt; 
; "{
;   \"timestamp\" : \"2020-07-18T17:00:54.954Z\",
;   \"level\" : \"INFO\",
;   \"thread\" : \"nREPL-session-ea7676d2-b76c-44c4-bc2b-d1c2f8515c0b\",
;   \"ns\" : \"example.logging\",
;   \"line\" : 32,
;   \"column\" : 1,
;   \"target-schema-version\" : 10,
;   \"type\" : \"example.logging/database.migrating\",
;   \"logger\" : \"example.logging\",
;   \"message\" : \"example.logging/database.migrating\",
;   \"context\" : \"default\"
; }
; "

(log/debug logger ::database.migrated
  {:current-schema-version 10 :elapsed-millis 568}
  {:message "Success!"})
; =&gt;
; "{
;   \"timestamp\" : \"2020-07-18T17:02:10.798Z\",
;   \"level\" : \"DEBUG\",
;   \"thread\" : \"nREPL-session-ea7676d2-b76c-44c4-bc2b-d1c2f8515c0b\",
;   \"ns\" : \"example.logging\",
;   \"line\" : 50,
;   \"current-schema-version\" : 10,
;   \"column\" : 1,
;   \"elapsed-millis\" : 568,
;   \"type\" : \"example.logging/database.migrated\",
;   \"logger\" : \"example.logging\",
;   \"message\" : \"Success!\",
;   \"context\" : \"default\"
; }

(log/error logger ::cache.connecting
  {:address "tcp://cache.example.com:3456"}
  {:exception (ex-info "Connection failed" {:timeout-millis 500})})
; =&gt;
; "{
;   \"timestamp\" : \"2020-07-18T17:03:13.756Z\",
;   \"level\" : \"ERROR\",
;   \"thread\" : \"nREPL-session-ea7676d2-b76c-44c4-bc2b-d1c2f8515c0b\",
;   \"address\" : \"tcp://cache.example.com:3456\",
;   \"ns\" : \"example.logging\",
;   \"line\" : 69,
;   \"column\" : 1,
;   \"type\" : \"example.logging/cache.connecting\",
;   \"logger\" : \"example.logging\",
;   \"message\" : \"example.logging/cache.connecting\",
;   \"context\" : \"default\",
;   \"exception\" : \"clojure.lang.ExceptionInfo: Connection failed\
; \\tat example.logging$eval6273.invokeStatic(form-init17428929335843016668.clj:3)\
; \\tat example.logging$eval6273.invoke(form-init17428929335843016668.clj:1)\
; \\tat clojure.lang.Compiler.eval(Compiler.java:7177)\
; \\tat clojure.lang.Compiler.eval(Compiler.java:7132)\
; \\tat clojure.core$eval.invokeStatic(core.clj:3214)\
; \\tat clojure.core$eval.invoke(core.clj:3210)\
; \\tat nrepl.middleware.interruptible_eval$evaluate$fn__3914.invoke(interruptible_eval.clj:91)\
; \\tat clojure.main$repl$read_eval_print__9086$fn__9089.invoke(main.clj:437)\
; \\tat clojure.main$repl$read_eval_print__9086.invoke(main.clj:437)\
; \\tat clojure.main$repl$fn__9095.invoke(main.clj:458)\
; \\tat clojure.main$repl.invokeStatic(main.clj:458)\
; \\tat clojure.main$repl.doInvoke(main.clj:368)\
; \\tat clojure.lang.RestFn.invoke(RestFn.java:1523)\
; \\tat nrepl.middleware.interruptible_eval$evaluate.invokeStatic(interruptible_eval.clj:84)\
; \\tat nrepl.middleware.interruptible_eval$evaluate.invoke(interruptible_eval.clj:56)\
; \\tat nrepl.middleware.interruptible_eval$interruptible_eval$fn__3940$fn__3944.invoke(interruptible_eval.clj:155)\
; \\tat clojure.lang.AFn.run(AFn.java:22)\
; \\tat nrepl.middleware.session$session_exec$main_loop__4041$fn__4045.invoke(session.clj:190)\
; \\tat nrepl.middleware.session$session_exec$main_loop__4041.invoke(session.clj:189)\
; \\tat clojure.lang.AFn.run(AFn.java:22)\
; \\tat java.lang.Thread.run(Thread.java:748)\
; \"
; }
; "
</code></pre></div></div></div></body></html>